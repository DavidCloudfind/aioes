language: python

python:
- "3.4"
- "3.5"
- "3.6"

dist: trusty  # beta, but it has docker
sudo: false

services:
- docker

install:
- pip install -r requirements-dev.txt
- pip install codecov
- pip install elasticsearch

script:
- make $TASKS

after_script:
- codecov

cache:
- apt
- pip

before_cache:
  - rm -f $HOME/.cache/pip/log/debug.log

env:
  global:
  - TASKS="cov setup-check" TEST_ARGS="-rsxX -v"
  matrix:
  - PYTHONASYNCIODEBUG=1
  - PYTHONASYNCIODEBUG=
matrix:
  include:
  - python: "3.6"
    env: TASKS="cmp"
  - python: "3.6"
    env: TASKS="cov" TEST_ARGS="-rsxX -v --es-tag=2.4 --es-tag=5.2"
  allow_failures:
  - env: TASKS="cov" TEST_ARGS="-rsxX -v --es-tag=2.4 --es-tag=5.2"

deploy:
  provider: pypi
  user: andrew.svetlov
  password:
    secure: DoeWNoPsOJzD9MheKAAnBiycRs6bnsro0PNmfe5Rj0N3tS0ocm6oyOOUtmLqGX41C97neremBUxTokp6lE9awmmJbTxUacOa6yleoPAr0VTphWx4vMuQSLNON8pUhjnHJbY3+1/34/BV3b4XL+jegiikh3tpeOvCVDfXh4JORRI=
  distributions: "sdist bdist_wheel"
  on:
    tags: true
    all_branches: true
    python: 3.5
